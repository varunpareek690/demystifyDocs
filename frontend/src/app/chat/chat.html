<div class="chat-view-container">
  <div class="pdf-viewer-section">
    <app-pdf-viewer [pdfUrl]="pdfUrl()" [filename]="document()?.filename || 'document.pdf'"></app-pdf-viewer>

    <div class="chat-overlay-section" [class.collapsed]="isChatCollapsed()" [class.is-resizing]="isDragging()" [style.height.vh]="isChatCollapsed() ? null : chatHeightVh()">
      <div class="resizer-y" (mousedown)="startResize($event, 'height')"></div>
      
      <button class="collapse-button" (click)="toggleChat()" title="Toggle chat window">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>

      <div class="conversation-area">
        <div class="error-message" *ngIf="error()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
          <span>{{ error() }}</span>
        </div>

        <div class="messages-container">
          <div class="message" *ngFor="let message of messages()" [class.user-message]="message.role === 'user'" [class.ai-message]="message.role === 'AI'">
            <div class="message-avatar">
              <svg *ngIf="message.role === 'user'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
              <svg *ngIf="message.role === 'AI'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 12h1m5-7h1m6 7h1m-7 7h1m-6.1-2.1-1-1m1-11.8-1-1m11.8 1 1-1m-1 11.8 1 1M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"></path></svg>
            </div>
            <div class="message-content">
              <div class="message-text">{{ message.content }}</div>
              <div class="message-time">{{ message.timestamp | date:'shortTime' }}</div>
            </div>
          </div>

          <div class="message ai-message" *ngIf="isLoading()">
            <div class="message-avatar">
              <div class="typing-indicator"><span></span><span></span><span></span></div>
            </div>
            <div class="message-content">
              <div class="message-text">Thinking...</div>
            </div>
          </div>
        </div>

        <div class="suggested-questions" *ngIf="suggestedQuestions().length > 0 && messages().length === 0">
          <h4>Suggested Questions:</h4>
          <div class="question-buttons">
            <button *ngFor="let question of suggestedQuestions().slice(0, 4)" class="question-button" (click)="useSuggestedQuestion(question)" [disabled]="isLoading()">
              {{ question }}
            </button>
          </div>
        </div>
      </div>

      <div class="input-area">
        <div class="input-container">
          <input type="text" placeholder="Ask a question about your document..." [value]="currentMessage()" (input)="onInputChange($event)" (keydown)="onKeyDown($event)" [disabled]="isLoading()" class="message-input">
          <button class="send-button" (click)="sendMessage()" [disabled]="!currentMessage().trim() || isLoading()" title="Send message">
            <svg *ngIf="!isLoading()" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <div *ngIf="isLoading()" class="button-spinner"></div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="resizer-x" (mousedown)="startResize($event, 'width')"></div>

  <div class="summary-section" [style.width.px]="summaryWidth()">
    <div class="summary-header">
      <h3 class="summary-title">Document Summary</h3>
      <div class="document-info" *ngIf="document()">
        <span class="document-name">{{ document()!.title }}</span>
        <span class="document-type">{{ document()!.document_type || 'Document' }}</span>
      </div>
    </div>
    <div class="summary-content">
        <div class="summary-data" *ngIf="summary()">
          <div class="summary-section-item">
            <h4>Summary</h4>
            <p>{{ summary()!.summary }}</p>
          </div>
          <div class="summary-section-item" *ngIf="summary()!.key_points?.length">
            <h4>Key Points</h4>
            <ul><li *ngFor="let point of summary()!.key_points">{{ point }}</li></ul>
          </div>
          <div class="summary-section-item" *ngIf="summary()!.complexity_score">
            <h4>Complexity</h4>
            <div class="complexity-indicator">
              <div class="complexity-bar"><div class="complexity-fill" [style.width.%]="summary()!.complexity_score * 10"></div></div>
              <span>{{ summary()!.complexity_score }}/10</span>
            </div>
          </div>
      </div>
    </div>
  </div>
</div>